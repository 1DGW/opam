#!/bin/bash

set -e

curl -L https://github.com/ocaml/opam/releases/download/${OPAM_VERSION}/opam-${OPAM_VERSION}-x86_64-linux >/usr/local/bin/opam
chmod +x /usr/local/bin/opam

if [ ${OPAM_VARIANT} = "plain" ]; then EXTRA_FLAGS=--disable-sandboxing; fi

opam init --root=$HOME/opam-root-$COMPILER-${OPAM_VARIANT} -j $NJOBS --compiler=$COMPILER -n -y $EXTRA_FLAGS
eval $(opam env --root=${HOME}/opam-root-$COMPILER-${OPAM_VARIANT} --set-root)
opam config list
opam install -j $NJOBS -y camlp5 ocamlfind $EXTRA_OPAM
opam list
mkdir -p $HOME/opam-cache
tar czf $HOME/opam-cache/cache-$COMPILER-${OPAM_VARIANT}.tgz $HOME/opam-root-$COMPILER-${OPAM_VARIANT}
